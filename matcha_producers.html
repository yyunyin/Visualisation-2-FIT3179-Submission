<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Share of Global Matcha Production</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Match main page fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
  
  <style>
    body { 
      font-family: 'Noto Sans JP', sans-serif; 
      margin: 0; 
      padding: 0; 
      background: transparent;
      font-weight: 300;
      color: #2c3e2a;
    }
    .wrap { 
      max-width: 1000px; 
      margin: 24px auto 48px; 
      padding: 0 16px; 
      text-align: center; 
    }
    h1 { 
      margin: 0 0 12px; 
      font-family: 'Noto Serif JP', serif;
      font-size: 28px; 
      font-weight: 600; 
      color: #2c3e2a; 
      letter-spacing: 0.5px;
    }
    #vis { 
      width: 100%; 
      padding: 6px 0; 
    }
    .note { 
      color: #5a6e57; 
      font-size: 12px; 
      margin: 8px 0 0; 
      line-height: 1.4; 
      font-style: italic; 
      text-align: left;
      font-weight: 300;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
  <div class="wrap">
    <h1>Share of Global Matcha Production</h1>

    <div id="vis"
         role="img"
         aria-label="Choropleth map of CHN/JPN/KOR/VNM showing share of global matcha production in 2024."></div>

    <p class="note">
      <em>
        * production values are accurate approximations based off data sourced from various news articles and reports<br>
        * remaining 5.91% of matcha production is on local farms for local use, data is unavailable
      </em>
    </p>
  </div>

  <script>
    const GEO_URL = "asia.geo.json";
    const CSV_URL = "matcha_countries_producer.csv";

    const spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "background": null,
      "width": "container",
      "height": 600,
      "autosize": { "type": "fit", "contains": "padding" },
      "view": { "stroke": null },
      "projection": { "type": "mercator", "center": [110, 34], "scale": 580 },

      "layer": [
        { "data": { "sphere": true }, "mark": { "type": "geoshape", "fill": "#e6f2ff", "stroke": null } },
        { "data": { "graticule": { "step": [3, 3] } },
          "mark": { "type": "geoshape", "fill": null, "stroke": "#cfe0f5", "strokeWidth": 0.6 } },
        { "data": { "url": GEO_URL, "format": { "type": "json", "property": "features" } },
          "mark": { "type": "geoshape", "fill": "#e6e6e6", "stroke": "white", "strokeWidth": 0.6 } },

        { "data": { "url": GEO_URL, "format": { "type": "json", "property": "features" } },
          "transform": [
            { "calculate": "datum.properties.adm0_a3", "as": "iso3_geo" },
            { "lookup": "iso3_geo",
              "from": { "data": { "url": CSV_URL }, "key": "iso3", "fields": ["tonnes_2024"] } },
            { "calculate": "toNumber(datum.tonnes_2024)", "as": "tonnes_num" },
            { "joinaggregate": [{ "op": "sum", "field": "tonnes_num", "as": "global_total" }] },
            { "calculate": "datum.global_total && datum.tonnes_num ? datum.tonnes_num / datum.global_total : null",
              "as": "share_global" },
            { "filter": "indexof(['CHN','JPN','KOR','VNM'], datum.iso3_geo) >= 0" }
          ],
          "mark": { "type": "geoshape", "stroke": "white", "strokeWidth": 1.0, "strokeJoin": "round" },
          "encoding": {
            "color": {
              "field": "share_global",
              "type": "quantitative",
              "scale": { "scheme": "greens", "domain": [0, 0.5], "clamp": true },
              "legend": {
                "orient": "none",
                "legendX": 600,
                "legendY": 520,
                "direction": "horizontal",
                "title": "Share of global (0â€“50%)",
                "format": ".0%",
                "titleFontSize": 12,
                "labelFontSize": 10,
                "gradientLength": 360,
                "gradientThickness": 12,
                "values": [0, 0.1, 0.2, 0.3, 0.4, 0.5]
              }
            },
            "tooltip": [
              { "field": "properties.name", "title": "Country" },
              { "field": "iso3_geo", "title": "ISO3" },
              { "field": "tonnes_num", "title": "Tonnes (2024)", "type": "quantitative", "format": ",.0f" },
              { "field": "share_global", "title": "Share of global", "type": "quantitative", "format": ".2%" }
            ]
          }
        }
      ]
    };

    vegaEmbed("#vis", spec, { actions: false });
  </script>
</body>
</html>